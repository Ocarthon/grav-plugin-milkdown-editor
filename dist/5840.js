"use strict";(self.webpackChunkmilkdown=self.webpackChunkmilkdown||[]).push([[5840],{5840:(e,t,r)=>{r.d(t,{defineFeature:()=>S});var o=r(2845),i=r(8262);class s{constructor(e,t){var r;this.editorView=e,this.cursorPos=null,this.element=null,this.timeout=-1,this.width=null!==(r=t.width)&&void 0!==r?r:1,this.color=!1===t.color?void 0:t.color||"black",this.class=t.class,this.handlers=["dragover","dragend","drop","dragleave"].map((t=>{let r=e=>{this[t](e)};return e.dom.addEventListener(t,r),{name:t,handler:r}}))}destroy(){this.handlers.forEach((({name:e,handler:t})=>this.editorView.dom.removeEventListener(e,t)))}update(e,t){null!=this.cursorPos&&t.doc!=e.state.doc&&(this.cursorPos>e.state.doc.content.size?this.setCursor(null):this.updateOverlay())}setCursor(e){e!=this.cursorPos&&(this.cursorPos=e,null==e?(this.element.parentNode.removeChild(this.element),this.element=null):this.updateOverlay())}updateOverlay(){let e,t=this.editorView.state.doc.resolve(this.cursorPos),r=!t.parent.inlineContent,o=this.editorView.dom,i=o.getBoundingClientRect(),s=i.width/o.offsetWidth,n=i.height/o.offsetHeight;if(r){let r=t.nodeBefore,o=t.nodeAfter;if(r||o){let t=this.editorView.nodeDOM(this.cursorPos-(r?r.nodeSize:0));if(t){let i=t.getBoundingClientRect(),s=r?i.bottom:i.top;r&&o&&(s=(s+this.editorView.nodeDOM(this.cursorPos).getBoundingClientRect().top)/2);let l=this.width/2*n;e={left:i.left,right:i.right,top:s-l,bottom:s+l}}}}if(!e){let t=this.editorView.coordsAtPos(this.cursorPos),r=this.width/2*s;e={left:t.left-r,right:t.left+r,top:t.top,bottom:t.bottom}}let l,a,d=this.editorView.dom.offsetParent;if(this.element||(this.element=d.appendChild(document.createElement("div")),this.class&&(this.element.className=this.class),this.element.style.cssText="position: absolute; z-index: 50; pointer-events: none;",this.color&&(this.element.style.backgroundColor=this.color)),this.element.classList.toggle("prosemirror-dropcursor-block",r),this.element.classList.toggle("prosemirror-dropcursor-inline",!r),!d||d==document.body&&"static"==getComputedStyle(d).position)l=-pageXOffset,a=-pageYOffset;else{let e=d.getBoundingClientRect(),t=e.width/d.offsetWidth,r=e.height/d.offsetHeight;l=e.left-d.scrollLeft*t,a=e.top-d.scrollTop*r}this.element.style.left=(e.left-l)/s+"px",this.element.style.top=(e.top-a)/n+"px",this.element.style.width=(e.right-e.left)/s+"px",this.element.style.height=(e.bottom-e.top)/n+"px"}scheduleRemoval(e){clearTimeout(this.timeout),this.timeout=setTimeout((()=>this.setCursor(null)),e)}dragover(e){if(!this.editorView.editable)return;let t=this.editorView.posAtCoords({left:e.clientX,top:e.clientY}),r=t&&t.inside>=0&&this.editorView.state.doc.nodeAt(t.inside),o=r&&r.type.spec.disableDropCursor,s="function"==typeof o?o(this.editorView,t,e):o;if(t&&!s){let e=t.pos;if(this.editorView.dragging&&this.editorView.dragging.slice){let t=(0,i.Um)(this.editorView.state.doc,e,this.editorView.dragging.slice);null!=t&&(e=t)}this.setCursor(e),this.scheduleRemoval(5e3)}}dragend(){this.scheduleRemoval(20)}drop(){this.scheduleRemoval(20)}dragleave(e){this.editorView.dom.contains(e.relatedTarget)||this.setCursor(null)}}var n=r(4413),l=r(8903),a=r(1575);class d extends o.LN{constructor(e){super(e,e)}map(e,t){let r=e.resolve(t.map(this.head));return d.valid(r)?new d(r):o.LN.near(r)}content(){return l.Ji.empty}eq(e){return e instanceof d&&e.head==this.head}toJSON(){return{type:"gapcursor",pos:this.head}}static fromJSON(e,t){if("number"!=typeof t.pos)throw new RangeError("Invalid input for GapCursor.fromJSON");return new d(e.resolve(t.pos))}getBookmark(){return new c(this.anchor)}static valid(e){let t=e.parent;if(t.isTextblock||!function(e){for(let t=e.depth;t>=0;t--){let r=e.index(t),o=e.node(t);if(0!=r)for(let e=o.child(r-1);;e=e.lastChild){if(0==e.childCount&&!e.inlineContent||e.isAtom||e.type.spec.isolating)return!0;if(e.inlineContent)return!1}else if(o.type.spec.isolating)return!0}return!0}(e)||!function(e){for(let t=e.depth;t>=0;t--){let r=e.indexAfter(t),o=e.node(t);if(r!=o.childCount)for(let e=o.child(r);;e=e.firstChild){if(0==e.childCount&&!e.inlineContent||e.isAtom||e.type.spec.isolating)return!0;if(e.inlineContent)return!1}else if(o.type.spec.isolating)return!0}return!0}(e))return!1;let r=t.type.spec.allowGapCursor;if(null!=r)return r;let o=t.contentMatchAt(e.index()).defaultType;return o&&o.isTextblock}static findGapCursorFrom(e,t,r=!1){e:for(;;){if(!r&&d.valid(e))return e;let i=e.pos,s=null;for(let r=e.depth;;r--){let o=e.node(r);if(t>0?e.indexAfter(r)<o.childCount:e.index(r)>0){s=o.child(t>0?e.indexAfter(r):e.index(r)-1);break}if(0==r)return null;i+=t;let n=e.doc.resolve(i);if(d.valid(n))return n}for(;;){let n=t>0?s.firstChild:s.lastChild;if(!n){if(s.isAtom&&!s.isText&&!o.nh.isSelectable(s)){e=e.doc.resolve(i+s.nodeSize*t),r=!1;continue e}break}s=n,i+=t;let l=e.doc.resolve(i);if(d.valid(l))return l}return null}}}d.prototype.visible=!1,d.findFrom=d.findGapCursorFrom,o.LN.jsonID("gapcursor",d);class c{constructor(e){this.pos=e}map(e){return new c(e.map(this.pos))}resolve(e){let t=e.resolve(this.pos);return d.valid(t)?new d(t):o.LN.near(t)}}const u=(0,n.K)({ArrowLeft:h("horiz",-1),ArrowRight:h("horiz",1),ArrowUp:h("vert",-1),ArrowDown:h("vert",1)});function h(e,t){const r="vert"==e?t>0?"down":"up":t>0?"right":"left";return function(e,i,s){let n=e.selection,l=t>0?n.$to:n.$from,a=n.empty;if(n instanceof o.U3){if(!s.endOfTextblock(r)||0==l.depth)return!1;a=!1,l=e.doc.resolve(t>0?l.after():l.before())}let c=d.findGapCursorFrom(l,t,a);return!!c&&(i&&i(e.tr.setSelection(new d(c))),!0)}}function p(e,t,r){if(!e||!e.editable)return!1;let i=e.state.doc.resolve(t);if(!d.valid(i))return!1;let s=e.posAtCoords({left:r.clientX,top:r.clientY});return!(s&&s.inside>-1&&o.nh.isSelectable(e.state.doc.nodeAt(s.inside))||(e.dispatch(e.state.tr.setSelection(new d(i))),0))}function f(e,t){if("insertCompositionText"!=t.inputType||!(e.state.selection instanceof d))return!1;let{$from:r}=e.state.selection,i=r.parent.contentMatchAt(r.index()).findWrapping(e.state.schema.nodes.text);if(!i)return!1;let s=l.FK.empty;for(let e=i.length-1;e>=0;e--)s=l.FK.from(i[e].createAndFill(null,s));let n=e.state.tr.replace(r.pos,r.pos,new l.Ji(s,0,0));return n.setSelection(o.U3.near(n.doc.resolve(r.pos+1))),e.dispatch(n),!1}function m(e){if(!(e.selection instanceof d))return null;let t=document.createElement("div");return t.className="ProseMirror-gapcursor",a.zF.create(e.doc,[a.NZ.widget(e.selection.head,t,{key:"gapcursor"})])}var v=r(797);function g(e,t){return Object.assign(e,{meta:{package:"@milkdown/plugin-cursor",...t}}),e}const w=(0,v.Qx)({},"dropCursorConfig");g(w,{displayName:"Ctx<dropCursor>"});const y=(0,v.Gf)((e=>function(e={}){return new o.k_({view:t=>new s(t,e)})}(e.get(w.key))));g(y,{displayName:"Prose<dropCursor>"});const C=(0,v.Gf)((()=>new o.k_({props:{decorations:m,createSelectionBetween:(e,t,r)=>t.pos==r.pos&&d.valid(r)?new d(r):null,handleClick:p,handleKeyDown:u,handleDOMEvents:{beforeinput:f}}})));g(C,{displayName:"Prose<gapCursor>"});const k=[w,y,C];var b=new o.hs("prosemirror-virtual-cursor");function x(e){const t=e.index(),r=e.parent.maybeChild(t);let o=e.textOffset?r:null;return!o&&t>0&&(o=e.parent.maybeChild(t-1)),[null==o?void 0:o.marks,null==r?void 0:r.marks]}function A(e){return e&&"object"==typeof e&&"$cursor"in e}const S=(e,t)=>{if(e.config((e=>{e.update(w.key,(()=>{var e,r;return{class:"crepe-drop-cursor",width:null!=(e=null==t?void 0:t.width)?e:4,color:null!=(r=null==t?void 0:t.color)&&r}}))})).use(k),!1===(null==t?void 0:t.virtual))return;const r=function(e){var t;const r=null!=(t=null==e?void 0:e.skipWarning)&&t;let i="undefined"==typeof document?null:document.createElement("div");return new o.k_({key:b,view:e=>{!0!==r&&function(e,t){for(const[r,o]of Object.entries(e.marks))!1!==o.spec.inclusive||t.includes(r)||console.warn(`[prosemirror-virtual-cursor] Virtual cursor does not work well with marks that have inclusive set to false. Please consider removing the inclusive option from the "${r}" mark or adding it to the "skipWarning" option.`)}(e.state.schema,r||[]);const t=e.dom.ownerDocument;i=i||document.createElement("div");const o=i,s=()=>{!function(e,t){if(!e||!e.dom||e.isDestroyed||!t)return;const{state:r,dom:o}=e,{selection:i}=r;if(!A(i))return;const s=function(e,t){var r;const o=window.getSelection();if(!o||!o.rangeCount)return null;const i=null==(r=null==o?void 0:o.getRangeAt(0))?void 0:r.cloneRange();if(!i)return null;i.collapse(t);const s=i.getClientRects(),n=(null==s?void 0:s.length)?s[s.length-1]:null;return(null==n?void 0:n.height)?n:e.coordsAtPos(e.state.selection.head)}(e,i.$head===i.$from);if(!s)return t;const n=o.getBoundingClientRect();let a="prosemirror-virtual-cursor";const d=r.selection.$head,[c,u]=x(d),h=r.storedMarks||d.marks();i.$cursor&&c&&u&&h&&!l.CU.sameSet(c,u)&&(l.CU.sameSet(c,h)?a+=" prosemirror-virtual-cursor-left":l.CU.sameSet(u,h)&&(a+=" prosemirror-virtual-cursor-right")),t.className=a,function(e,t){e.classList.remove(t),e.offsetWidth,e.classList.add(t)}(t,"prosemirror-virtual-cursor-animation"),t.style.height=s.bottom-s.top+"px",t.style.left=s.left-n.left+"px",t.style.top=s.top-n.top+"px"}(e,o)};let n;return window.ResizeObserver&&(n=new window.ResizeObserver((()=>s())),n.observe(e.dom)),t.addEventListener("selectionchange",s),{update:()=>{s()},destroy:()=>{t.removeEventListener("selectionchange",s),n&&n.unobserve(e.dom)}}},props:{handleKeyDown:(e,t)=>{var r;const{selection:i}=e.state;if(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey||t.isComposing||!["ArrowLeft","ArrowRight"].includes(t.key)||!A(i)||!i.empty)return!1;const s=i.$head,[n,a]=x(s),d=e.state.storedMarks||s.marks();if(n&&a&&!l.CU.sameSet(n,a)){if("ArrowLeft"===t.key&&!l.CU.sameSet(n,d))return e.dispatch(e.state.tr.setStoredMarks(n)),!0;if("ArrowRight"===t.key&&!l.CU.sameSet(a,d))return e.dispatch(e.state.tr.setStoredMarks(a)),!0}return"ArrowLeft"===t.key&&1===s.textOffset?(e.dispatch(e.state.tr.setSelection(o.U3.create(e.state.doc,s.pos-1)).setStoredMarks(s.marks())),!0):"ArrowRight"===t.key&&s.textOffset+1===(null==(r=s.parent.maybeChild(s.index()))?void 0:r.nodeSize)&&(e.dispatch(e.state.tr.setSelection(o.U3.create(e.state.doc,s.pos+1)).setStoredMarks(s.marks())),!0)},decorations:e=>{if(i&&A(e.selection)&&e.selection.empty)return a.zF.create(e.doc,[a.NZ.widget(0,i,{key:"prosemirror-virtual-cursor"})])},attributes:{class:"virtual-cursor-enabled"}}})}();e.use((0,v.Gf)((()=>r)))}}}]);